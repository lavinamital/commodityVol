# Data
---
title: "Data"
format:
  html:
    code-fold: true
---

```{r}
#| label: setup
#| message: false
#| warning: false

library(tidyverse)
library(janitor)
library(lubridate)
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)

commod_raw <- readr::read_rds("data/raw/commodities_raw.rds")

dplyr::glimpse(commod_raw)
```

## Description (2.1)
For this project I use daily futures data for three major commodities: gold (GC=F), WTI crude oil (CL=F), and natural gas (NG=F). The data is downloaded from Yahoo Finance using the tq_get() function in tidyquant package, which provides access to Yahoo’s historical price data. I pulled data from Jan 1, 2014 to now so I could capture several years of "normal" market behavior as well as the periods around the three major global events I analyze later (COVID-19 pandemic, the Russian invasion of Ukraine, and the Israel–Hamas escalation). For each commodity, the raw data set includes the daily open, high, low, and close prices, the adjusted closing price (which I rename to price and base my analysis on). I used the adjusted price because it pulls together the different futures contracts over time, creating a smooth and consistent time series. The data set also contains daily trading volume. I construct two additional variables: a simple daily return, defined as price / lag(price) − 1, which captures the day-to-day percentage change in price, and a log return, log(price / lag(price)), which is easier to work with over longer horizons because log returns add up cleanly across days and treat up and down moves more symmetrically. The raw data used in this chapter are stored in the repository at data/raw/commodities_raw.rds and were generated by the script scripts/pull_commodities.R, which documents the exact download parameters.

## Missing value analysis

```{r}

missing_by_var <- commod_raw |>
  dplyr::summarize(dplyr::across(dplyr::everything(), ~ sum(is.na(.x)))) |>
  tidyr::pivot_longer(
    cols = dplyr::everything(),
    names_to = "variable",
    values_to = "n_missing"
  )

missing_by_var

ggplot2::ggplot(missing_by_var,
       ggplot2::aes(x = reorder(variable, n_missing),
                    y = n_missing)) +
  ggplot2::geom_col() +
  ggplot2::coord_flip() +
  ggplot2::labs(
    title = "Missing values by variable",
    x = "Variable",
    y = "Count of missing values"
  ) +
  ggplot2::theme_minimal(base_size = 14)


```
The bar chart shows that almost all of the missing values occur in the two return variables (ret_simple and ret_log), which is expected because the first observation for each ticker has no prior price and therefore no return. The only other variable with any missingness is volume, and even there the total number of missing entries is very small. All of the price-related variables (price, open, high, low, close) have essentially no missing values, which suggests the underlying futures data from Yahoo Finance is very complete. This makes sense since Yahoo Finance is a very reputed and well documented source to pull data from.

```{r}

#| label: missing-over-time
#| fig.cap: "Missing price and volume values over time."
#| warning: false
#| message: false

# 1. Compute missingness per date
missing_over_time <- commod_raw |>
  dplyr::group_by(date) |>
  dplyr::summarise(
    n_missing_price  = sum(is.na(price)),
    n_missing_volume = sum(is.na(volume)),
    .groups = "drop"
  )

ggplot() +
  geom_line(
    data = missing_over_time,
    aes(x = date, y = n_missing_volume, color = "n_missing_volume"),
    linewidth = 1
  ) +
  geom_hline(
    aes(yintercept = 0, color = "n_missing_price"),
    linewidth = 1
  ) +
  scale_color_manual(
    name   = "Variable",
    values = c(
      "n_missing_price"  = "red",
      "n_missing_volume" = "blue"
    ),
    labels = c(
      "n_missing_price"  = "Price (missing count)",
      "n_missing_volume" = "Volume (missing count)"
    )
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  labs(
    title = "Missing price and volume over time",
    x = "Date",
    y = "Number of missing values across tickers"
  ) +
  theme_minimal(base_size = 14)


```
The time-series view confirms that missing values are extremely rare and occur only for the volume variable. There are just a few isolated dates with missing volume and no dates at all with missing prices. These gaps are likely due to occasional exchange holidays or incomplete reporting rather than a systematic issue. Because they are so sparse, I can safely drop those rows or ignore them in later plots without affecting the overall patterns.


```{r}

missing_heat <- commod_raw |>
  mutate(across(-c(date, ticker), ~ is.na(.x))) |>
  tidyr::pivot_longer(
    cols = -c(date, ticker),
    names_to = "variable",
    values_to = "is_missing"
  )

missing_heat_zoom <- missing_heat |>
  dplyr::filter(is_missing)

ggplot(missing_heat_zoom,
       aes(x = date, y = variable, fill = is_missing)) +
  geom_tile() +
  scale_fill_manual(values = c("FALSE" = "white", "TRUE" = "red")) +
  labs(
    title = "Missing value heatmap, zoomed into missing days",
    x = "Date",
    y = "Variable",
    fill = "Missing?"
  ) +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```
The heatmap makes the missingness pattern even more apparent. The thin red stripes for ret_simple and ret_log at the start of the sample correspond to the first day for each ticker, where returns are undefined by construction. A few additional red tiles for volume line up with the isolated missing days seen in the time-series plot. The absence of red tiles for the price variables again indicates that price data are fully observed. Overall, the missing values are rare, localized, and do not require any special treatment beyond ignoring the first return for each series.
